# 项目架构

## 分层架构
```
+---------------------------+
|        应用层 (业务逻辑)    |
+---------------------------+
|        服务层 (功能模块)    |
+---------------------------+
|        网络层(asio封装)     |
+---------------------------+
|         Asio 库本身        |
+---------------------------+
```
**网络层**
```cpp
class TCPServer : public std::enable_shared_from_this<TCPServer> {
public:
    using Ptr = std::shared_ptr<TCPServer>;
    using ConnectionHandler = std::function<void(const std::string&)>;
    using MessageHandler = std::function<void(const std::string&, const std::string&)>;
    using DisconnectionHandler = std::function<void(const std::string&)>;
    
    static Ptr create(asio::io_context& io_context, uint16_t port);
    
    void start();
    void stop();
    
    void set_connection_handler(ConnectionHandler handler);
    void set_message_handler(MessageHandler handler);
    void set_disconnection_handler(DisconnectionHandler handler);
    
    bool send(const std::string& client_id, const std::string& message);
    void broadcast(const std::string& message);
    
private:
    TCPServer(asio::io_context& io_context, uint16_t port);
    
    void do_accept();
    
    asio::io_context& io_context_;
    asio::ip::tcp::acceptor acceptor_;
    
    ConnectionHandler connection_handler_;
    MessageHandler message_handler_;
    DisconnectionHandler disconnection_handler_;
    
    // 内部连接管理...
};
```

**服务层**
```cpp
// services/chat_service.h
#pragma once
#include "network/tcp_server.h"
#include <string>
#include <map>

namespace services {

class ChatService {
public:
    ChatService(network::TCPServer::Ptr server);
    
    void start();
    void stop();
    
    void handle_message(const std::string& client_id, const std::string& message);
    void handle_connection(const std::string& client_id);
    void handle_disconnection(const std::string& client_id);
    
    void register_user(const std::string& client_id, const std::string& username);
    
private:
    network::TCPServer::Ptr server_;
    std::map<std::string, std::string> client_username_map_; // client_id -> username
    
    void send_welcome_message(const std::string& client_id);
    void broadcast_user_joined(const std::string& username);
    void broadcast_user_left(const std::string& username);
};

} // namespace services

```

**应用层**
```cpp
// app/chat_application.h
#pragma once
#include "services/chat_service.h"
#include "network/tcp_server.h"
#include <asio.hpp>

namespace app {

class ChatApplication {
public:
    ChatApplication(uint16_t port);
    
    void initialize();
    void run();
    void shutdown();
    
private:
    asio::io_context io_context_;
    network::TCPServer::Ptr server_;
    services::ChatService::Ptr chat_service_;
    
    // 工作线程池
    std::vector<std::thread> thread_pool_;
    
    void setup_logging();
    void setup_configuration();
    void setup_signals();
};

} // namespace app

```


# 性能优化
## 使用多线程模型
充分利用多核cpu
在多个线程中调用io_context::run

## 分离服务和IO线程
asio主要负责io,cpu密集型的计算任务放到其他线程(池)中

## 合理使用和管理内存
主要是接受缓冲区和发送缓冲区，可以使用内存池，或者参考muduo中的buffer设计

## 合理使用零拷贝
sendfile

## 尽量减少系统调用
比如发送数据可以将多个缓冲区合并发送

## 连接管理
使用连接池，超时机制，心跳机制

## 性能测试

**性能指标**

- 吞吐量：单位时间内处理的请求数或数据量
- 延迟：请求发出到收到响应的时间间隔
- 并发连接数：系统能同时处理的连接数
- 资源使用率：CPU、内存、网络等资源的使用情况

**测试工具**

- ab (Apache Benchmark)：简单的HTTP基准测试工具
- wrk：高性能HTTP基准测试工具
- siege：多线程HTTP/HTTPS负载测试工具
- JMeter：功能强大的负载测试工具
- netcat：网络连接测试工具

**分析工具**
- Linux：perf, gprof, strace
- Windows：Visual Studio Performance Profiler
- 第三方工具：Valgrind, Intel VTune

**常见问题**
| 性能瓶颈     | 可能原因                       | 解决方案                         |
|--------------|--------------------------------|------------------------------------|
| 高CPU使用率  | 忙等待、过多的小数据I/O操作    | 检查事件循环、合并小的I/O操作      |
| 高内存使用   | 内存泄漏、缓冲区过大           | 使用内存分析工具、调整缓冲区大小   |
| 连接建立延迟 | DNS解析慢、握手过程长          | 实现DNS缓存、使用连接池            |
| 吞吐量低     | 线程模型不合理、系统调用频繁   | 优化线程模型、批量处理操作         |
| 锁竞争激烈   | 过多的共享数据、锁粒度大       | 减少共享数据、减小锁粒度           |


# 高性能api网关

- 路由请求到后端服务
- 负载均衡
- 请求/响应转换
- 认证和授权
- 限流和熔断

```cpp
+-------------------+
|     接入层         |  // 接受客户端连接
+-------------------+
        |
+-------------------+
|     路由层         |  // 路由请求到后端服务
+-------------------+
        |
+-------------------+
|     服务发现层      |  // 发现和健康检查后端服务
+-------------------+
        |
+-------------------+
|     后端服务集群     |  // 实际处理业务逻辑
+-------------------+
```
