# æ¦‚è¿°
æ— é”ç¼–ç¨‹æ˜¯ä¸€ç§åœ¨å¤šçº¿ç¨‹ä¹‹é—´å®‰å…¨åœ°å…±äº«ä¸æ–­å˜åŒ–çš„æ•°æ®è€Œæ— éœ€è·å–å’Œé‡Šæ”¾é”çš„æ–¹æ³•ï¼Œæ— æ‰€ç¼–ç¨‹æ˜¯éå¸¸å¤æ‚çš„ï¼Œä½¿ç”¨å‰å¿…é¡»äº†è§£å…¶å¤æ‚æ€§å¹¶ä»”ç»†è¡¡é‡ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨æ›´ç®€å•æ›´å¿«çš„è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚æ›´å°‘åœ°å…±äº«æ•°æ®ã€‚

"One important consequence of lock-free programming is that if you suspend a single thread, it will never prevent other threads from making progress, as a group, through their own lock-free operatio
æ— é”ç¼–ç¨‹çš„ä¸€ä¸ªé‡è¦åæœæ˜¯ï¼šå¦‚æœä½ æŒ‚èµ·ï¼ˆæš‚åœï¼‰äº†æŸä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒæ°¸è¿œä¸ä¼šé˜»æ­¢å…¶ä»–çº¿ç¨‹ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œé€šè¿‡å®ƒä»¬è‡ªå·±çš„æ— é”æ“ä½œç»§ç»­å‘å‰æ¨è¿›ã€‚

æ·±å…¥è§£é‡Šï¼š
åœ¨ä¼ ç»Ÿçš„åŸºäºé”çš„å¹¶å‘ç¨‹åºä¸­ï¼ˆæ¯”å¦‚ä½¿ç”¨ mutex äº’æ–¥é”ï¼‰ï¼š
```
çº¿ç¨‹A è·å–äº†ä¸€ä¸ªé”ï¼Œå¼€å§‹æ“ä½œå…±äº«æ•°æ®ã€‚
çº¿ç¨‹B æƒ³è®¿é—®åŒä¸€æ•°æ®ï¼Œå°±ä¼šé˜»å¡ç­‰å¾…è¿™ä¸ªé”ã€‚
å¦‚æœæ­¤æ—¶çº¿ç¨‹A è¢«æ“ä½œç³»ç»ŸæŒ‚èµ·ï¼ˆä¾‹å¦‚ï¼šæ—¶é—´ç‰‡ç”¨å®Œã€è¢«ä¸­æ–­ã€è¿›å…¥ä¼‘çœ ç­‰ï¼‰ï¼Œé‚£ä¹ˆçº¿ç¨‹B å°±ä¼šä¸€ç›´ç­‰å¾…ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œã€‚
ğŸ‘‰ è¿™å°±æ˜¯æ‰€è°“çš„â€œé”æŒæœ‰è€…è¢«æŒ‚èµ·é—®é¢˜â€ï¼Œå®ƒä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿâ€œå¡ä½â€ã€‚
```

è€Œåœ¨æ— é”ç¼–ç¨‹ä¸­ï¼š
```
æ²¡æœ‰çº¿ç¨‹ä¼šâ€œç‹¬å â€æŸä¸ªèµ„æºï¼ˆå› ä¸ºæ²¡æœ‰é”ï¼‰ã€‚
æ‰€æœ‰çº¿ç¨‹é€šè¿‡åŸå­æ“ä½œï¼ˆå¦‚ CAS, compare-and-swapï¼‰æ¥ç«äº‰ä¿®æ”¹å…±äº«æ•°æ®ã€‚
å³ä½¿æŸä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«æŒ‚èµ·ï¼Œå…¶ä»–çº¿ç¨‹ä»ç„¶å¯ä»¥ç»§ç»­å°è¯•å®Œæˆè‡ªå·±çš„æ“ä½œï¼Œå› ä¸ºå®ƒä»¬ä¸ä¾èµ–äºé‚£ä¸ªè¢«æŒ‚èµ·çš„çº¿ç¨‹é‡Šæ”¾é”ã€‚
âœ… æ‰€ä»¥ï¼Œå•ä¸ªçº¿ç¨‹çš„æŒ‚èµ·ä¸ä¼šé˜»å¡æ•´ä¸ªç³»ç»Ÿçš„è¿›å±•ã€‚
```

# åŸå­æ“ä½œ
ä¸€ç§ä¸å¯åˆ†å‰²çš„å†…å­˜æ“ä½œï¼ŒRMW(è¯»å–->ä¿®æ”¹->å†™å…¥)è¿™ä¸ªè¿‡ç¨‹è¢«çœ‹ä½œä¸€ä¸ªæ•´ä½“
æ¯ä¸ªå¹³å°éƒ½æœ‰å„è‡ªçš„å®ç°æ¯”å¦‚windowsçš„_InterlockedIncrement,IOSçš„OSAtomicAdd32

c++åœ¨11å¼€å§‹å¼•å…¥äº†åŸå­å˜é‡ï¼Œstd::atomic<int>::fetch_addå°±æ˜¯ä¸€ä¸ªRMWæ“ä½œï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯c++11åŸå­æ ‡å‡†ä¸ä¿è¯åœ¨æ¯ä¸ªå¹³å°ä¸Šçš„å®ç°éƒ½æ˜¯æ— é”çš„ï¼Œå¯ä»¥è°ƒç”¨std::atmoic<>::is_lock_freeæ¥éªŒè¯

```cpp
std::atomic<int> value{10};

// åŸºæœ¬æ“ä½œ
value.store(20);                    // å­˜å‚¨å€¼
int old_val = value.load();         // åŠ è½½å€¼
int prev = value.exchange(30);      // äº¤æ¢å€¼å¹¶è¿”å›æ—§å€¼

// ç®—æœ¯æ“ä½œ
value.fetch_add(5);                 // åŸå­åŠ æ³•ï¼Œè¿”å›æ—§å€¼
value.fetch_sub(3);                 // åŸå­å‡æ³•ï¼Œè¿”å›æ—§å€¼
value.fetch_and(0xFF);              // åŸå­æŒ‰ä½ä¸
value.fetch_or(0x0F);               // åŸå­æŒ‰ä½æˆ–
value.fetch_xor(0xAA);              // åŸå­æŒ‰ä½å¼‚æˆ–

// é€’å¢é€’å‡
++value;  // ç­‰ä»·äº value.fetch_add(1) + 1
value++;  // ç­‰ä»·äº value.fetch_add(1)
--value;  // ç­‰ä»·äº value.fetch_sub(1) - 1
value--;  // ç­‰ä»·äº value.fetch_sub(1)

```

# CAS (Compare-And-Swap)

CASæ˜¯æ— é”ç¼–ç¨‹çš„æ ¸å¿ƒæ“ä½œï¼Œå®ƒåŸå­æ€§åœ°æ¯”è¾ƒå¹¶äº¤æ¢å€¼ã€‚